{% load static %}
<!DOCTYPE html>
<html lang="en" dir="ltr" data-startbar="dark" data-bs-theme="light">

<head>
    <meta charset="utf-8" />
    <title>{% block title %}Détails du projet{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta content="Premium Multipurpose Admin & Dashboard Template" name="description" />
    <meta content="" name="author" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- App favicon -->
    <link rel="shortcut icon" href="{% static 'web/assets/images/favicon.ico' %}">

    <!-- App css -->

    <link href="{% static 'web/assets/libs/mobius1-selectr/selectr.min.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'web/assets/css/bootstrap.min.css' %}" rel="stylesheet" type="text/css" />

    <link href="{% static 'web/assets/css/icons.min.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'web/assets/css/app.min.css' %}" rel="stylesheet" type="text/css" />

    <link href="{% static 'web/assets/css/esri_main.css' %}" rel="stylesheet" type="text/css" />

    <style>

        #viewDiv{
            width:100%;
            height:80vh;
        }
        @media (max-width: 768px) {
        .esri-basemap-gallery__item-container {
            flex-flow: row nowrap;
            gap: 12px;
            margin: 0;
            padding-block: 3px;
            padding-inline: 3px;
            list-style: none;
            transition: opacity .25s ease-in-out;
            display: flex;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        }
        .esri-sketch__feature-count-badge{
            display: none;
        }
    </style>
</head>

<body>

        <!-- Top Bar Start -->
        <div class="topbar d-print-none">
            <div class="container-xxl">
                <nav class="topbar-custom d-flex justify-content-between" id="topbar-custom">    
            
    
                    <ul class="topbar-item list-unstyled d-inline-flex align-items-center mb-0">                        
                        <li>
                            <button class="nav-link mobile-menu-btn nav-icon" id="togglemenu">
                                <i class="iconoir-menu-scale"></i>
                            </button>
                        </li> 
                        <li class="mx-3 welcome-text">
                            <h3 class="mb-0 fw-bold text-truncate"></h3>
                            <!-- <h6 class="mb-0 fw-normal text-muted text-truncate fs-14">Here's your overview this week.</h6> -->
                        </li>                   
                    </ul>
                    <ul class="topbar-item list-unstyled d-inline-flex align-items-center mb-0">
                        <!--end topbar-language-->
            
                        <li class="dropdown topbar-item">
                            <a class="nav-link dropdown-toggle arrow-none nav-icon" data-bs-toggle="dropdown" href="#" role="button"
                                aria-haspopup="false" aria-expanded="false">
                                <img src="{% static 'web/assets/icons/icon_user.svg' %}" alt="" class="thumb-lg rounded-circle" style="width: 50px;height: 36px;">
                            </a>
                            <div class="dropdown-menu dropdown-menu-end py-0">
                                <div class="d-flex align-items-center dropdown-item py-2 bg-secondary-subtle">
                                    <div class="flex-shrink-0">
                                        <img src="{% static 'web/assets/icons/icon_user.svg' %}" alt="" class="thumb-md rounded-circle" style="width: 50px;height: 36px;">
                                    </div>
                                    <div class="flex-grow-1 ms-2 text-truncate align-self-center">
                                        <h6 class="my-0 fw-medium text-dark fs-13">{{ username }}</h6>
                                        <small class="text-muted mb-0">{{ role }}</small>
                                    </div><!--end media-body-->
                                </div>
                                <div class="dropdown-divider mb-0"></div>
                                <a class="dropdown-item text-danger" href="/logout/"><i class="las la-power-off fs-18 me-1 align-text-bottom"></i>Déconnexion</a>
                            </div>
                        </li>
                    </ul><!--end topbar-nav-->
                </nav>
                <!-- end navbar-->
            </div>
        </div>
        <!-- Top Bar End -->
    
    
    <!-- leftbar-tab-menu -->
    <div class="startbar d-print-none">
        <!--start brand-->
        <div class="brand">
            <a href="/dashboard/" class="logo" style="font-size:23px;color:rgb(43 45 59);">
                <span>
                    <img src="{% static 'web/assets/images/logo-sm.png' %}" alt="logo-small" class="logo-sm" style="border-radius: 5px;margin-top: -8px;box-shadow: 1px 1px 4px #eee;">
                </span>
                <span id="logo-text" class="logo-lg logo-light">
                    AfricanMaps
                </span>
            </a>
        </div>        
        <!--end brand-->
        <!--start startbar-menu-->
        <div class="startbar-menu" >
            <div class="startbar-collapse" id="startbarCollapse" data-simplebar>
                <div class="d-flex align-items-start flex-column w-100">
                    <!-- Navigation -->
                    <ul class="navbar-nav mb-auto w-100">
                        
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard/">
                                <i class="iconoir-home-simple menu-icon"></i>
                                <span>Tableau de bord</span>
                            </a>
                        </li><!--end nav-item-->
                        
                        <li class="nav-item">
                            <a class="nav-link" href="#sidebarLocations" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="sidebarLocations">
                                <i class="iconoir-map menu-icon"></i>
                                <span>Projets</span>
                            </a>
                            <div class="collapse" id="sidebarLocations">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a href="/map/" class="nav-link">Ajouter un Projet</a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="/locations/" class="nav-link">Gérer les Projets</a>
                                    </li>
                                </ul><!--end nav-->
                            </div>
                        </li><!--end nav-item-->
                        
                        <li class="nav-item">
                            <a class="nav-link" href="#sidebarItems" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="sidebarItems">
                                <i class="iconoir-frame-select menu-icon"></i>
                                <span>Éléments de Cartographie</span>
                            </a>
                            <div class="collapse" id="sidebarItems">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a href="/manage-items/" class="nav-link">Gérer les Éléments</a>
                                    </li>
                                </ul><!--end nav-->
                            </div>
                        </li><!--end nav-item-->
                        
                        <li class="nav-item">
                            <a class="nav-link" href="#sidebarMediaFiles" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="sidebarMediaFiles">
                                <i class="iconoir-camera menu-icon"></i>
                                <span>Fichiers Multimédias</span>
                            </a>
                            <div class="collapse" id="sidebarMediaFiles">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a href="/manage-media/" class="nav-link">Gérer les Médias</a>
                                    </li>
                                </ul><!--end nav-->
                            </div>
                        </li><!--end nav-item-->
                        
                        <li class="nav-item">
                            <a class="nav-link" href="#sidebarReports" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="sidebarReports">
                                <i class="iconoir-archive menu-icon"></i>
                                <span>Rapports</span>
                            </a>
                            <div class="collapse" id="sidebarReports">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a href="/rapport/project/" class="nav-link">Rapports de Projets</a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="/rapport/elements/" class="nav-link">Rapports de Éléments</a>
                                    </li>
                                </ul><!--end nav-->
                            </div>
                        </li><!--end nav-item-->
                        
                        <li class="nav-item">
                            <a class="nav-link" href="#sidebarKMLKMZ" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="sidebarKMLKMZ">
                                <i class="iconoir-transition-down menu-icon"></i>
                                <span>Gestion KML/KMZ</span>
                            </a>
                            <div class="collapse" id="sidebarKMLKMZ">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a href="/import/kml-kmz/" class="nav-link">Importer KML/KMZ</a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="/exporter/kml-kmz/" class="nav-link">Exporter KML/KMZ</a>
                                    </li>
                                </ul><!--end nav-->
                            </div>
                        </li><!--end nav-item-->

                        <li class="nav-item">
                            <a class="nav-link" href="#sidebarUserManagement" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="sidebarUserManagement">
                                <i class="iconoir-community menu-icon"></i>
                                <span>Gestion des Utilisateurs</span>
                            </a>
                            <div class="collapse" id="sidebarUserManagement">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a href="/users/" class="nav-link">Liste des Utilisateurs</a>
                                    </li>
                                </ul><!--end nav-->
                            </div>
                        </li><!--end nav-item-->
                        
                        <li class="nav-item">
                            <a class="nav-link" href="#sidebarSettings" data-bs-toggle="collapse" role="button" aria-expanded="false" aria-controls="sidebarSettings">
                                <i class="iconoir-settings menu-icon"></i>
                                <span>Paramètres</span>
                            </a>
                            <div class="collapse" id="sidebarSettings">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a href="geojson-settings.html" class="nav-link">Paramètres GeoJSON</a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="file-upload-settings.html" class="nav-link">Paramètres de Téléversement</a>
                                    </li>
                                </ul><!--end nav-->
                            </div>
                        </li><!--end nav-item-->
                        
                    </ul><!--end navbar-nav--->
                    
                </div>
            </div><!--end startbar-collapse-->
        </div>
        <!--end startbar-menu-->    
    </div><!--end startbar-->
    <div class="startbar-overlay d-print-none"></div>
    <!-- end leftbar-tab-menu-->
        
    
    <!-- Page Wrapper -->
    <div class="page-wrapper">

        <!-- Page Content-->
        <div class="page-content">
            <div class="container-xxl">
                
                {% if messages %}
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm border-theme-white-2" role="alert">
                        <div class="d-inline-flex justify-content-center align-items-center thumb-xs 
                            {% if message.tags == 'success' %} bg-success
                            {% elif message.tags == 'danger' %} bg-danger
                            {% elif message.tags == 'warning' %} bg-warning
                            {% elif message.tags == 'info' %} bg-purple
                            {% else %} bg-secondary {% endif %} 
                            rounded-circle mx-auto me-1">
                            <i class="fas 
                                {% if message.tags == 'success' %} fa-check
                                {% elif message.tags == 'danger' %} fa-xmark
                                {% elif message.tags == 'warning' %} fa-exclamation
                                {% elif message.tags == 'info' %} fa-info
                                {% else %} fa-info {% endif %}
                                align-self-center mb-0 text-white"></i>
                        </div>
                        {{ message|safe }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endfor %}
                {% endif %}



    <div class="row justify-content-center">


    <div class="col-lg">
        
        <div class="card mb-4 text-align-last-center">
            <div class="card-body">
                <div class="row justify-content-center text-center">
                    <div class="col-12 col-md-3">
                        <label class="form-label">Nom du Projet:</label>
                        <p class="form-control-plaintext">{{ location.name }}</p>
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="form-label">Description:</label>
                        <p class="form-control-plaintext">{{ location.description|truncatechars:100}}</p>
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="form-label">Date de création:</label>
                        <p class="form-control-plaintext">{{ location.created_at|date:"Y/m/d" }}</p>
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="form-label">Statut:</label>
                        <p class="form-control-plaintext">
                            {% if location.archived %}
                        <span class="badge rounded-pill border border-danger text-danger p-1 mb-2 d-block">
                            Statut : Archivé
                        </span>
                    {% else %}
                        <span class="badge rounded-pill border border-success text-success p-1 mb-2 d-block">
                            Statut : Actif
                        </span>
                    {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
              
            <!-- Container for Bootstrap Toasts -->
            <div class="toast-container position-absolute top-50 start-50 translate-middle-x p-3" style="top: 70%;" id="toastPlacement"></div>
            
            <!-- Formulaire de mise à jour des info -->
            <div id="viewDiv"></div>

            
             <!-- Modal pour ajouter un nouvel élément avec la capture de caméra -->
            <div class="modal fade" id="CreateItemModal" tabindex="-1" aria-labelledby="CreateItemModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-fullscreen-lg-down">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="CreateItemModalLabel">Créer un élément</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                        </div>
                        <form method="POST" action="{% url 'add-item' location.id %}" enctype="multipart/form-data" style="background-color: #fff;">
                            <div class="modal-body">
                                {% csrf_token %}
                                <div class="form-group mb-3">
                                    <label for="itemName">Nom</label>
                                    <input type="text" class="form-control" id="itemName" name="name" value="Élément {{ last_number }}" required />
                                </div>
                                <div class="form-group mb-3">
                                    <label for="itemDescription">Description</label>
                                    <textarea class="form-control" id="itemDescription" name="description" placeholder="Description" required></textarea>
                                </div>
                                <div class="form-group mb-3">
                                    <div class="image-gallery" name="images"></div>
                                    <button type="button" class="take-video-btn btn btn-warning mb-2 w-100" hidden>
                                        <i class="fas fa-camera"></i> Capturer une image/vidéo
                                    </button>
                                    <input type="file" class="btn btn-outline-secondary form-control" name="media" id="imageInput" multiple accept="image/*,video/*" />
                                </div>
                                <input type="hidden" name="geojson" id="geojsonInput" />
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary">Enregistrer</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            

            <!-- Modal pour afficher les détails d'un élément -->
            <div class="modal fade" id="viewItemModal" tabindex="-1" aria-labelledby="viewItemModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-fullscreen-lg-down">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="viewItemModalLabel">Détails de l'élément</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="viewItemName" class="form-control mb-2" placeholder="Nom" readonly />
                            <textarea id="viewItemDescription" class="form-control mb-3" placeholder="Description" readonly></textarea>
                            <div id="mediaCarousel" class="carousel slide" data-bs-ride="carousel" style="width: 100%; max-height: 400px;">
                                <div class="carousel-inner" id="carouselInner"></div>
                                <a class="carousel-control-prev" href="#mediaCarousel" role="button" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="sr-only">Précédent</span>
                                </a>
                                <a class="carousel-control-next" href="#mediaCarousel" role="button" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="sr-only">Suivant</span>
                                </a>
                            </div>
                            <div id="placeDetails" class="mt-3 text-center d-none">
                                <strong id="placeName"></strong><br>
                                <p id="placeDescription"></p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal pour modifier un élément -->
            <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-fullscreen-lg-down">
                    <div class="modal-content">
                        <form id="edit-form" method="POST" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="modal-header">
                                <h5 class="modal-title" id="editModalLabel">Modifier l'élément</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                            </div>
                            <div class="modal-body">
                                <input type="hidden" id="edit-item-id" name="item_id">
                                <div class="form-group mb-3">
                                    <label for="edit-name">Nom :</label>
                                    <input type="text" class="form-control" id="edit-name" name="name" required>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="edit-description">Description :</label>
                                    <textarea class="form-control" id="edit-description" name="description" required></textarea>
                                </div>
                                <div class="form-group mb-3">
                                    <input type="file" class="btn btn-outline-secondary form-control" name="media" id="imageInput" multiple accept="image/*,video/*" />
                                    <div class="image-gallery mt-3" name="images"></div>
                                </div>
                                <input type="hidden" id="edit-geojson" name="geojson">
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary">Enregistrer</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                            </div>
                        </form>
                    </div>             
                </div>
            </div>


            <!-- Modal pour supprimer un élément -->
            <div class="modal fade" id="deleteItemModal" tabindex="-1" aria-labelledby="deleteItemModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-fullscreen-lg-down">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteItemModalLabel">Supprimer l'Élément</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Êtes-vous sûr de vouloir supprimer cet élément ?</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                            <button type="button" class="btn btn-danger" id="confirmDeleteButton">Supprimer</button>
                        </div>
                    </div>
                </div>
            </div>

            
            </div>
            </div>
        </div>
    </div>
</div>

 <!-- Pied de page -->
 <footer class="footer text-center text-sm-start d-print-none">
    <div class="container-xxl">
        <div class="row">
            <div class="col-12">
                <div class="card mb-0 rounded-bottom-0">
                    <div class="card-body">
                        <p class="text-muted mb-0">
                            © <script> document.write(new Date().getFullYear()) </script> AfricanMaps
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</footer>
<!-- Fin du pied de page -->


            </div><!-- container -->
        </div>
        <!-- end page content -->
    </div>
    <!-- end page-wrapper -->

<!-- Javascript  -->

<!-- Javascript  -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'web/assets/libs/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'web/assets/libs/mobius1-selectr/selectr.min.js' %}"></script>
<script src="{% static 'web/assets/libs/simplebar/simplebar.min.js' %}"></script>
<script src="{% static 'web/assets/js/app.js' %}"></script>
<script src="https://js.arcgis.com/4.30/"></script>



<script>

    require([
    "esri/Map",
    "esri/views/MapView",
    "esri/layers/GraphicsLayer",
    "esri/widgets/Sketch/SketchViewModel",
    "esri/widgets/Sketch",
    "esri/widgets/Search",
    "esri/widgets/Expand",
    "esri/widgets/BasemapGallery",
    "esri/widgets/Fullscreen",
    "esri/Basemap",
    "esri/Graphic",
    "esri/geometry/Point",
    "esri/geometry/Polygon",
    "esri/geometry/Polyline"
    ], function(Map, MapView, GraphicsLayer, SketchViewModel, Sketch, Search, Expand, BasemapGallery, Fullscreen, Basemap, Graphic, Point, Polygon, Polyline) {
        
        const graphicsLayer = new GraphicsLayer({ title: "Existing Features Layer" });
        const sketchLayer = new GraphicsLayer({ title: "New Features Layer" });
    
        const map = new Map({
            basemap: "satellite",
            layers: [graphicsLayer, sketchLayer]
        });
    
        const view = new MapView({
            container: "viewDiv",
            map: map,
            center: [-6.8498, 34.0209],
            zoom: 18,
            ui: {
                components: ["zoom"]
            }
        });
    
        // Load GeoJSON data from Django template
        const locationGeoJSON = JSON.parse(`{{ location_geojson|escapejs }}`);
        const itemsGeoJSON = JSON.parse(`{{ items_geojson|escapejs }}`);
    
        function addGeoJSONToMap(geojson, shouldZoom = false) {
            if (geojson && geojson.geometry) {
                let graphicGeometry;
                let symbol;
        
                if (geojson.geometry.rings) {
                    graphicGeometry = new Polygon({
                        rings: geojson.geometry.rings,
                        spatialReference: geojson.geometry.spatialReference
                    });
                    symbol = {
                        type: "simple-fill",
                        color: [19, 23, 44, 0.5], // لون بنفسجي مع شفافية 0
                        outline: {
                            color: [255, 165, 0], // لون الحدود برتقالي
                            width: 2
                        }
                    };
    
                } else if (geojson.geometry.paths) {
                    graphicGeometry = new Polyline({
                        paths: geojson.geometry.paths,
                        spatialReference: geojson.geometry.spatialReference
                    });
                    symbol = {
                        type: "simple-line",
                        color: [255, 165, 0], // لون أخضر زاهي
                        width: 2,
                        style: "solid", // خط ثابت غير متقطع
                    };
    
                } else if (geojson.geometry.x && geojson.geometry.y) {
                    graphicGeometry = new Point({
                        x: geojson.geometry.x,
                        y: geojson.geometry.y,
                        spatialReference: geojson.geometry.spatialReference
                    });
                    symbol = {
                        type: "simple-marker",
                        style: "circle",
                        color: [19,23,44, 0.95], // لون سماوي للنقاط
                        size: "13px",
                        outline: {
                            color: [255, 165, 0], // لون الحدود برتقالي
                            width: 2
                        }
                    };
                }
        
                const graphic = new Graphic({
                    geometry: graphicGeometry,
                    symbol: symbol,
                    attributes: {
                        id: geojson.properties?.id || "",
                        name: geojson.properties?.name || "عنصر بدون اسم",
                        description: geojson.properties?.description || "لا توجد تفاصيل.",
                        media: geojson.properties?.media || "لا توجد ميديا."
                    }
                });
        
                if (!shouldZoom) {
                    graphicsLayer.add(graphic);
                }
        
                if (shouldZoom) {
                    view.when(() => {
                        const targetGeometry = graphicGeometry.extent ? graphicGeometry.extent.expand(1.5) : graphicGeometry;
                        view.goTo({
                            target: targetGeometry,
                            zoom: 18
                        }, {
                            animate: !!graphicGeometry.extent
                        }).catch((error) => {
                            console.error("Error in goTo operation: ", error);
                        });
                    });
                }
            } else {
                console.error("Invalid or missing GeoJSON data.");
            }
        };
        
    
        // Display itemsGeoJSON on the map
        itemsGeoJSON.features.forEach(feature => addGeoJSONToMap(feature, false));
    
        // Use locationGeoJSON for zoom, but do not add it to the map
        addGeoJSONToMap(locationGeoJSON, true);
    
        const snappingLayer = graphicsLayer;
    
        
        const sketchViewModel = new SketchViewModel({
            view: view,
            layer: graphicsLayer,
            snappingOptions: {
            enabled: true,
            featureEnabled: true,
            selfEnabled: true,
            featureSources: [{ layer: graphicsLayer }]
            },
            polygonSymbol: {
            type: "simple-fill",
            color: [19, 23, 44, 0.5],
            outline: {
                color: [255, 165, 0],
                width: 2
            }
            },
            polylineSymbol: {
            type: "simple-line",
            color: [255, 165, 0],
            width: 2
            },
            pointSymbol: {
            type: "simple-marker",
            style: "circle",
            color: [19, 23, 44, 0.95],
            size: "13px",
            outline: {
                color: [255, 165, 0],
                width: 2
            }
            }
        });
    
        
        const sketch = new Sketch({
            view: view,
            layer: graphicsLayer,
            viewModel: sketchViewModel,
            layout: "vertical",
            snappingOptions: {
                enabled: true,
                featureEnabled: true,
                selfEnabled: true,
                featureSources: [
                    { layer: graphicsLayer, enabled: true, title: "Existing Features Layer" },
                    { layer: sketchLayer, enabled: true, title: "New Features Layer" }
                ]
            },
            visibleElements: {
                undoRedoMenu: false,
                settingsMenu: true,
                featureCount: false,
                duplicateFeature: false,
                deleteFeature: false
            }
        });
    
        // تفعيل عرض التولتيب بشكل افتراضي
        sketch.tooltipOptions.enabled = true;
            
        
        // إنشاء زر Undo
        const undoButton = document.createElement("div");
        undoButton.className = "esri-widget--button esri-interactive";
        undoButton.title = "Undo";
        undoButton.innerHTML = '<span class="esri-icon-undo"></span>';
        undoButton.onclick = () => {
            sketchViewModel.undo();
        };
    
        // إنشاء زر Redo
        const redoButton = document.createElement("div");
        redoButton.className = "esri-widget--button esri-interactive";
        redoButton.title = "Redo";
        redoButton.innerHTML = '<span class="esri-icon-redo"></span>';
        redoButton.onclick = () => {
            sketchViewModel.redo();
        };
    
        undoButton.style.visibility = "hidden";
        redoButton.style.visibility = "hidden";
    
        function showUndoRedoButtons() {
            undoButton.style.visibility = "visible";
            redoButton.style.visibility = "visible";
        }
    
        function hideUndoRedoButtons() {
            undoButton.style.visibility = "hidden";
            redoButton.style.visibility = "hidden";
        }
    
        // إضافة حدث لإنشاء العنصر إلى أداة الـ Sketch
        sketch.on("create", event => {
            if (event.state === "start") {
                showUndoRedoButtons(); // إظهار الأزرار عند بدء الرسم
            } else if (event.state === "complete") {
                activeGraphic = event.graphic; // تخزين العنصر المرسوم كعنصر نشط
                openCreateItemModal(event.graphic.toJSON()); // فتح نافذة لإضافة التفاصيل بعد الانتهاء من الرسم
                hideUndoRedoButtons(); // إخفاء الأزرار عند اكتمال الرسم
            }
        });
    
        
        function updateGraphicOnServer(itemId, geojsonData, updatedGraphic) {
            // بناء كائن GeoJSON كامل
            const completeGeoJSON = {
                aggregateGeometries: null,
                geometry: geojsonData,
                symbol: {
                    type: "esriSLS",
                    color: [130, 130, 130, 255],
                    width: 1.5,
                    style: "esriSLSSolid"
                },
                attributes: {},
                popupTemplate: null
            };
    
            fetch(`/item/${itemId}/update/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    geojson: completeGeoJSON
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showBootstrapToast('L\'élément a été mis à jour avec succès!', "success");
    
                    sketchLayer.remove(updatedGraphic);
                    graphicsLayer.add(updatedGraphic);
                } else {
                    showBootstrapToast('Erreur lors de la mise à jour de l\'élément: ' + data.message, "danger");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showBootstrapToast('Une erreur s\'est produite lors de l\'envoi de la demande.', "danger");
            });
        }
    
        const fullscreen = new Fullscreen({
            view: view 
        });
    
        view.ui.add(fullscreen, "top-right");
    
        const searchWidget = new Search({
            view: view,
            allPlaceholder: "Search for a place",
            locationEnabled: true,
        });
    
        const searchExpand = new Expand({
            view: view,
            content: searchWidget,
            expandIconClass: "esri-icon-search", // أيقونة البحث
            expandTooltip: "Click to search", // نص الإرشاد عند تمرير الفأرة
            expanded: false, // تأكد من أنه غير مفعل تلقائيًا حتى يظهر فقط عند 
            mode: "floating"
        });
    
    
        const basemapGallery = new BasemapGallery({
            view: view
        });
    
        // استخدام عنصر Expand لعرض BasemapGallery بشكل أفضل
        const basemapExpand = new Expand({
            view: view,
            content: basemapGallery,
            expandIconClass: "esri-icon-basemap", // أيقونة خريطة أساس
            expandTooltip: "Toggle Basemap Gallery" // نص توضيحي يظهر عند تمرير الماوس
        });
    
    
        // نقل أداة التكبير والتصغير إلى الأعلى اليسار
        view.ui.move("zoom", "top-right");
    
        const sketchExpand = new Expand({
            view: view,
            content: sketch,
            expandIconClass: "analysis-overlay",
            expandTooltip: "Click to draw",
            expanded: false,
            mode: "floating"
        });
    
        view.ui.add(sketchExpand, {
            position: "top-left",
            index: 1
        });
    
    
        // إضافة الأزرار إلى واجهة المستخدم
        view.ui.add(undoButton, "top-left");
        view.ui.add(redoButton, "top-left");
    
    
    
        
        // إضافة عنصر Expand إلى واجهة المستخدم في الموضع المطلوب
        view.ui.add(basemapExpand, {
            position: "top-right"
        });
    
        // إضافة أداة Expand إلى واجهة المستخدم مع أداة البحث
        view.ui.add(searchExpand, {
            position: "top-right",
            index: 2 // ترتيب أعلى بقليل من أداة التكبير وأداة الرسم
        });
    
    
        // إنشاء div جديد يحتوي على الأزرار
        const actionButtonsDiv = document.createElement('div');
        actionButtonsDiv.id = 'actionButtonsDiv';
        actionButtonsDiv.style.display = 'flex';
        actionButtonsDiv.style.flexDirection = 'column';
        actionButtonsDiv.style.alignItems = 'center';
        actionButtonsDiv.style.gap = '5px'; // تقليل المسافة بين الأزرار
    
        // دالة لإنشاء الأزرار بالشكل المطلوب
        function createButton(icon, title, clickHandler) {
            const button = document.createElement('button');
            button.title = title;
    
            // تصميم الزر ليكون أصغر حجمًا
            button.style.border = 'none'; // إزالة الحدود
            button.style.background = '#ffffff'; // خلفية بيضاء
            button.style.width = '32px'; // جعل العرض والارتفاع موحد وصغير
            button.style.height = '32px';
            button.style.borderRadius = '5px'; // تقليل الزوايا المستديرة
            button.style.display = 'flex';
            button.style.alignItems = 'center';
            button.style.justifyContent = 'center';
            button.style.cursor = 'pointer';
            button.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.2);'; // تقليل الظل ليبدو أخف
            button.style.padding = '0';
            button.style.margin = '0';
    
            // إضافة الأيقونة للزر
            const iconElement = document.createElement('calcite-icon');
            iconElement.setAttribute('icon', icon);
            iconElement.setAttribute('scale', 's'); // تصغير الأيقونة ليتناسب مع حجم الزر
            iconElement.setAttribute('aria-hidden', 'true');
            button.appendChild(iconElement);
    
            // إضافة حدث عند النقر
            button.addEventListener('click', clickHandler);
    
            return button;
        }
    
        function saveItem(itemId) {
            const updatedGraphic = window.selectedGraphic;
    
            if (!updatedGraphic) {
                alert("لا يوجد عنصر محدد للحفظ.");
                return;
            }
    
            const updatedGeoJSON = updatedGraphic.geometry ? updatedGraphic.geometry.toJSON() : null;
    
            if (updatedGeoJSON) {
                // استدعاء الدالة لحفظ البيانات على الخادم
                updateGraphicOnServer(itemId, updatedGeoJSON, updatedGraphic);
            } else {
                console.error('GeoJSON غير صالح أو غير متوفر.');
            }
        }
    
        // إنشاء زر إظهار المعلومات
        const showInfoButton = createButton("information", "Show Information", () => {
            if (window.selectedGraphic) {
                const attributes = window.selectedGraphic.attributes || {};
                const media = attributes.media || [];
                openViewItemModal(attributes.name, attributes.description, media);
            } else {
                alert('No selected graphic to show information.');
            }
        });
        actionButtonsDiv.appendChild(showInfoButton);
    
    
        // إنشاء زر التعديل أسفل زر الحفظ
        const editButton = createButton("save-as", "Edit feature", () => {
            if (window.selectedGraphic && window.selectedGraphic.attributes) {
                const attributes = window.selectedGraphic.attributes || {};
                const id = attributes.id;
                handleEditButtonClick(id, attributes.name, attributes.description);
            } else {
                alert('No selected graphic to edit.');
            }
        });
        actionButtonsDiv.appendChild(editButton);
    
        // تعريف دالة handleEditButtonClick لاستدعاء openEditModal
        function handleEditButtonClick(id, name, description) {
            openEditModal(id, name, description, JSON.stringify(window.selectedGraphic.geometry.toJSON()));
        }
    
        // إنشاء زر الحفظ
        const saveButton = createButton("save", "Save feature", () => {
            if (window.selectedGraphic && window.selectedGraphic.attributes) {
                const itemId = window.selectedGraphic.attributes.id;
                saveItem(itemId);
            } else {
                alert("No selected graphic to save.");
            }
        });
        actionButtonsDiv.appendChild(saveButton);
    
        
        // Créer le bouton de suppression et lui associer une fonction pour afficher le modal de confirmation
        const deleteButton = createButton("trash", "Supprimer l'élément", () => {
            // Vérifier s'il y a un élément graphique sélectionné pour la suppression
            if (window.selectedGraphic && window.selectedGraphic.attributes) {
                const itemId = window.selectedGraphic.attributes.id;
                openDeleteModal(itemId);  // Appeler le modal pour confirmer la suppression
            } else {
                alert('Aucun graphique sélectionné à supprimer.');
            }
        });
        actionButtonsDiv.appendChild(deleteButton);
    
        // إضافة الأزرار إلى واجهة المستخدم
        view.ui.add(actionButtonsDiv, {
            position: "top-left",
            index: 1 // إضافة بعد أداة Sketch
        });
    
        // التحكم في إظهار وإخفاء الأزرار بناءً على تحديد العنصر
        function updateButtonsVisibility() {
            if (window.selectedGraphic) {
                actionButtonsDiv.style.display = 'flex';
            } else {
                actionButtonsDiv.style.display = 'none';
            }
        }
    
        // إخفاء الأزرار افتراضيًا في البداية
        actionButtonsDiv.style.display = 'none';
    
        // مراقبة التحديدات على الخريطة لتحديث عرض الأزرار
        view.on("click", function(event) {
            view.hitTest(event).then(function(response) {
                const graphic = response.results.find(result => result.graphic.layer === graphicsLayer || result.graphic.layer === sketchLayer);
    
                if (graphic) {
                    const clickedGraphic = graphic.graphic;
                    window.selectedGraphic = clickedGraphic; // تخزين العنصر المحدد في المتغير العالمي
    
                    // تحديث عرض الأزرار بعد التحديد
                    updateButtonsVisibility();
    
                } else {
                    window.selectedGraphic = null; // إذا لم يتم تحديد عنصر، إفراغ المتغير
                    updateButtonsVisibility(); // تحديث عرض الأزرار لإخفائها
                }
            });
        });
    
        // Event listener for double-click to enable advanced editing of an existing graphic
        view.on("double-click", function (event) {
            event.stopPropagation(); // Prevent default double-click zoom behavior
    
            view.hitTest(event).then(function (response) {
                const graphic = response.results.find(result => result.graphic.layer === graphicsLayer || result.graphic.layer === sketchLayer);
    
                if (graphic) {
                    const clickedGraphic = graphic.graphic;
                    if (clickedGraphic.layer === graphicsLayer) {
                        // Move the graphic to the sketch layer to allow full editing capabilities
                        const clonedGraphic = clickedGraphic.clone();
                        graphicsLayer.remove(clickedGraphic); // Remove the graphic from the original layer
                        sketchLayer.add(clonedGraphic); // Add the graphic to the sketch layer
    
                        // Ensure the graphic has been added to the sketch layer before updating
                        if (sketchLayer.graphics.includes(clonedGraphic)) {
                            // Activate full editing mode for the graphic (reshape, move, add/remove parts)
                            sketch.update({
                                tool: "reshape", // Enable advanced editing with reshape tool
                                graphics: [clonedGraphic],
                                enableScaling: true,
                                enableRotation: true,
                                preserveAspectRatio: false, // Allow freeform reshaping
                                toggleToolOnClick: false, // Keep tool active for continuous editing
                                enableReshape: true, // Enable reshaping parts of geometry
                                reshapeOptions: {
                                    reshapeHandle: "vertices", // Allow editing vertices (for polygons/lines)
                                    reshapeMode: "all" // Enable reshape for all parts (lines, polygons)
                                }
                            });
                        }
                    } else if (clickedGraphic.layer === sketchLayer) {
                        // If already in the sketch layer, directly activate the reshape tool to edit
                        if (sketchLayer.graphics.includes(clickedGraphic)) {
                            sketch.update({
                                tool: "reshape",
                                graphics: [clickedGraphic],
                                enableScaling: true,
                                enableRotation: true,
                                preserveAspectRatio: false,
                                toggleToolOnClick: false,
                                enableReshape: true,
                                reshapeOptions: {
                                    reshapeHandle: "vertices",
                                    reshapeMode: "all"
                                }
                            });
                        }
                    }
                }
            });
        });
    
        
        
        // Function to show the Create Item Modal
        window.openCreateItemModal = function(geojson) {
            // تحديث قيمة الحقل المخفي للـ GeoJSON
            document.getElementById('geojsonInput').value = JSON.stringify(geojson);
            
            // استخدام Bootstrap لإظهار المودال
            $('#CreateItemModal').modal('show'); // إظهار المودال باستخدام Bootstrap's JavaScript API
        };

        // Function to close the Create Item Modal using Bootstrap's modal API
        window.closeCreateItemModal = function() {
            $('#CreateItemModal').modal('hide'); // Hide the modal using Bootstrap's API
        };

        // Event listener to handle the removal of the active graphic when the modal is fully hidden
        $('#CreateItemModal').on('hidden.bs.modal', function () {
            // Remove the active graphic from the graphics layer if it exists
            if (activeGraphic && graphicsLayer) {
                graphicsLayer.remove(activeGraphic);
                activeGraphic = null; // Reset the activeGraphic variable after removal
            }
        });
    
        window.openViewItemModal = function(name, description, media) {
            // تحديث اسم المكان والوصف في الـ modal
            document.getElementById('viewItemName').value = name || "Pas de nom";
            document.getElementById('viewItemDescription').value = description || "Aucun détail";
    
            // تحديث اسم المكان والوصف في قسم معلومات المكان
            document.getElementById('placeName').innerText = name || "Pas de nom";
            document.getElementById('placeDescription').innerText = description || "Aucun détail";
    
            // تحديث محتوى السلايدر
            const carouselInner = document.getElementById('carouselInner');
            carouselInner.innerHTML = ''; // تنظيف المحتوى السابق للسلايدر
    
            if (Array.isArray(media) && media.length > 0) {
                media.forEach((item, index) => {
                    const carouselItem = document.createElement('div');
                    carouselItem.className = `carousel-item ${index === 0 ? 'active' : ''}`;
    
    
                    // إضافة المحتوى بناءً على نوع الميديا (صورة أو فيديو)
                    const mediaContent = item.file_type === 'image'
                        ? `<img src="${item.file_url}" class="d-block w-100" alt="Media Image" style="height: 400px; object-fit: cover; border-radius: 15px;">`
                        : `<video controls class="d-block w-100" style="width: 100%;max-height: 400px;box-shadow: 1px 1px 5px 1px #eee;border-radius: 4px;">
                            <source src="${item.file_url}" type="video/mp4">
                        </video>`;
    
                    // إضافة أزرار التعديل والحذف للميديا
                    const mediaControls = `
                        <div class="carousel-caption d-flex justify-content-center align-items-center flex-nowrap">
                            <!-- زر التعديل -->
                            <form method="POST" action="/media/${item.id}/update/" enctype="multipart/form-data" class="d-inline-flex">
                                {% csrf_token %}
                                <input type="file" name="media_file" accept="image/*,video/*" style="display:none;" id="mediaInput${item.id}">
                                <button type="button" class="btn btn-warning btn-sm me-2 w-100" onclick="document.getElementById('mediaInput${item.id}').click();">Importer</button>
                                <button type="submit" class="btn btn-primary btn-sm me-2 w-100">Modifier</button>
                            </form>
                            <!-- زر الحذف -->
                            <form method="POST" action="/media/${item.id}/delete/" class="d-inline-flex">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger btn-sm w-100">Supprimer</button>
                            </form>
                        </div>`;
    
                    carouselItem.innerHTML = mediaContent ; // + mediaControls;
                    carouselInner.appendChild(carouselItem);
                });
            } else {
                const noMediaMessage = document.createElement('div');
                noMediaMessage.className = 'carousel-item active';
                noMediaMessage.innerHTML = '<p class="text-center">Il n\'y a aucun média à afficher.</p>';
                carouselInner.appendChild(noMediaMessage);
            }
    
            // عرض المودال
            $('#viewItemModal').modal('show');
        };
    
        window.closeViewItemModal = function() {
            $('#viewItemModal').modal('hide'); // إغلاق المودال باستخدام Bootstrap API
        };
    
        
        window.openEditModal = function(itemId, name, description, geojsonStr) {
            try {
                // Vérifier si geojsonStr est défini et non vide
                let geojson;
                if (geojsonStr) {
                    geojson = JSON.parse(geojsonStr.replace(/&quot;/g, '"'));
                    document.getElementById('edit-geojson').value = JSON.stringify(geojson);
                } else {
                    console.warn('geojsonStr est indéfini ou vide');
                    document.getElementById('edit-geojson').value = '';
                }
        
                // Remplir les champs du modal
                document.getElementById('edit-name').value = name || '';
                document.getElementById('edit-description').value = description || '';
                document.getElementById('edit-item-id').value = itemId;
        
                // Modifier l'action du formulaire pour qu'elle corresponde à l'opération souhaitée
                document.getElementById('edit-form').action = `/item/${itemId}/update/`;
        
                // Afficher le modal avec Bootstrap
                $('#editModal').modal('show');
            } catch (error) {
                console.error('Erreur dans geojsonStr:', geojsonStr, error);
                showBootstrapToast('Une erreur s\'est produite lors du traitement des données. Assurez-vous que les valeurs sont correctes.', 'danger');
            }
        };
    
        // Variable pour stocker l'ID de l'élément à supprimer
        
        let itemIdToDelete = null;

        window.openDeleteModal = function(itemId) {
            itemIdToDelete = itemId;  
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteItemModal'));
            deleteModal.show();  
        };

        document.getElementById('confirmDeleteButton').addEventListener('click', function() {
            if (itemIdToDelete !== null) {  
                fetch(`/item/${itemIdToDelete}/delete/`, {  
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'  
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Store the success message from the server in sessionStorage
                        sessionStorage.setItem('deleteSuccessMessage', data.message);
                        location.reload();  
                    } else {
                        showBootstrapToast('Erreur lors de la suppression de l\'élément: ' + data.message, "danger");
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    showBootstrapToast('Une erreur s\'est produite lors de l\'envoi de la demande.', "danger");  
                })
                .finally(() => {
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteItemModal'));
                    deleteModal.hide();
                    itemIdToDelete = null;  
                });
            }
        });

        // Show the success message after the page loads
        window.onload = function() {
            const message = sessionStorage.getItem('deleteSuccessMessage');
            if (message) {
                showBootstrapToast(message, "success");
                sessionStorage.removeItem('deleteSuccessMessage');  // Remove the message after displaying it
            }
        };


    
    });
    
    
    // Function to show toast notifications
    function showBootstrapToast(message, type) {
        const toastHTML = `
            <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">AfricanMaps</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        const toastContainer = document.getElementById('toastPlacement');
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);

        const toastElement = toastContainer.querySelector('.toast:last-child');
        const toastInstance = new bootstrap.Toast(toastElement);
        toastInstance.show();

        // Automatically hide the toast after 5 seconds
        setTimeout(() => {
            toastInstance.hide(); // Hide the toast
        }, 5000); // 5000 milliseconds = 5 seconds

        toastElement.addEventListener('hidden.bs.toast', function () {
            toastElement.remove();
        });
    }
        
    // Function to add media files (image/video) to the input field and the gallery
    function addMediaToInput(file) {
        const input = document.getElementById("imageInput");
        const dataTransfer = new DataTransfer();

        // Add existing files back to the input
        if (input.files.length > 0) {
            for (let i = 0; i < input.files.length; i++) {
                dataTransfer.items.add(input.files[i]);
            }
        }

        // Add the new file to the input
        dataTransfer.items.add(file);
        input.files = dataTransfer.files;
    }

    // Function to convert DataURL to File
    function dataURLtoFile(dataurl, filename, mimeType) {
        const arr = dataurl.split(',');
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while (n--) {
            u8arr[n] = bstr.charCodeAt(n);
        }
        return new File([u8arr], filename, { type: mimeType });
    }

    // Function to remove file from input
    function removeFileFromInput(fileName) {
        const input = document.getElementById("imageInput");
        const dataTransfer = new DataTransfer();

        // Add only the files that don't match the filename to the DataTransfer object
        for (let i = 0; i < input.files.length; i++) {
            if (input.files[i].name !== fileName) {
                dataTransfer.items.add(input.files[i]);
            }
        }

        // Update the input with the remaining files
        input.files = dataTransfer.files;
    }

    let imageCount = 1;  // لتعداد الصور
    let videoCount = 1;  // لتعداد الفيديوهات

    // Fonction pour ajouter une image à la galerie et à l'input
    function addImageToGallery(imageDataUrl) {
        const gallery = document.querySelector(".image-gallery");
        const div = document.createElement("div");
        div.className = "media-item position-relative mb-2";
        div.style.width = "150px"; // Set a fixed width for images and videos
        div.style.height = "150px"; // Set a fixed height for images and videos


        const img = document.createElement("img");
        img.src = imageDataUrl;
        img.style.width = "100%";
        img.style.height = "100%";
        img.style.objectFit = "cover";
        img.style.borderRadius = "8px";

        const fileName = `{{ location.name }}-image-${imageCount}.png`;  // استخدم اسم الـ location مع تسلسل رقمي
        imageCount++; 

        const removeBtn = document.createElement("button");
        removeBtn.innerText = "Supprimer";
        removeBtn.className = "btn btn-sm btn-danger position-absolute";
        removeBtn.style.top = "5px";
        removeBtn.style.right = "5px";
        removeBtn.onclick = function () {
            div.remove();
            removeFileFromInput(fileName);
            showBootstrapToast('Image supprimée avec succès !', 'danger');
        };


        div.appendChild(img);
        div.appendChild(removeBtn);
        gallery.appendChild(div);

        // Convertir l'URL de données de l'image en fichier et l'ajouter à l'input
        const imageFile = dataURLtoFile(imageDataUrl, fileName, "image/png");
        addMediaToInput(imageFile);
    }

    // Fonction pour ajouter une vidéo à la galerie et à l'input
    function addVideoToGallery(videoUrl) {
        const gallery = document.querySelector(".image-gallery");
        const div = document.createElement("div");
        div.className = "media-item position-relative mb-2";
        div.style.width = "150px"; // Set a fixed width for images and videos
        div.style.height = "150px"; // Set a fixed height for images and videos

        const videoElement = document.createElement("video");
        videoElement.controls = true;
        videoElement.src = videoUrl;
        videoElement.style.width = "100%";
        videoElement.style.height = "100%";
        videoElement.style.objectFit = "cover";
        videoElement.style.borderRadius = "8px";

        
        div.appendChild(videoElement);

        const fileName = `{{ location.name }}-video-${videoCount}.mp4`;  // استخدم اسم الـ location مع تسلسل رقمي
        videoCount++;  // زيادة العدد لتسلسل الفيديوهات

        const removeBtn = document.createElement("button");
        removeBtn.innerText = "Supprimer";
        removeBtn.className = "btn btn-sm btn-danger position-absolute";
        removeBtn.style.top = "5px";
        removeBtn.style.right = "5px";
        removeBtn.onclick = function () {
            div.remove();
            removeFileFromInput(fileName);
            showBootstrapToast('Image supprimée avec succès !', 'danger');
        };


        div.appendChild(removeBtn);
        gallery.appendChild(div);

        // Convertir l'URL de la vidéo en Blob puis en fichier, et l'ajouter à l'input
        fetch(videoUrl)
            .then(res => res.blob())
            .then(blob => {
                const videoFile = new File([blob], fileName, { type: "video/mp4" });
                addMediaToInput(videoFile);
            });
    }

    // Fonction pour ouvrir la caméra pour capturer des images ou enregistrer des vidéos
    function openCamera() {
        const modal = document.createElement("div");
        modal.className = "camera-modal";
        modal.style.position = 'fixed';
        modal.style.top = '35%';
        modal.style.left = '50%';
        modal.style.transform = 'translate(-50%, -50%)';
        modal.style.width = '100%';
        modal.style.maxWidth = '400px';
        modal.style.height = 'auto';
        modal.style.background = 'rgba(43, 45, 59, 0.9)';
        modal.style.padding = '15px';
        modal.style.borderRadius = '15px';
        modal.style.boxShadow = '0px 4px 15px rgba(43, 45, 59,0.5)';
        modal.style.zIndex = '10000';
        document.body.appendChild(modal);

        const video = document.createElement("video");
        video.autoplay = true;
        video.style.width = '100%'; // Pleine largeur de la vidéo
        video.style.height = 'auto';
        video.style.borderRadius = '8px';
        modal.appendChild(video);

        const captureBtn = document.createElement("button");
        captureBtn.innerText = "Capturer une image";
        captureBtn.className = "btn btn-primary mt-2";
        captureBtn.style.width = '100%'; // Pleine largeur du bouton
        modal.appendChild(captureBtn);

        const recordBtn = document.createElement("button");
        recordBtn.innerText = "Commencer l'enregistrement vidéo";
        recordBtn.className = "btn btn-warning mt-2";
        recordBtn.style.width = '100%'; // Pleine largeur du bouton
        modal.appendChild(recordBtn);

        const closeBtn = document.createElement("button");
        closeBtn.innerText = "Fermer";
        closeBtn.className = "btn btn-danger mt-2";
        closeBtn.style.width = '100%'; // Pleine largeur du bouton
        closeBtn.onclick = function () {
            modal.remove();
        };
        modal.appendChild(closeBtn);

        let mediaRecorder;
        let recordedChunks = [];

        // Accéder à la caméra arrière
        navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } })
            .then(function (stream) {
                video.srcObject = stream;

                // Capturer une image
                captureBtn.onclick = function () {
                    const canvas = document.createElement("canvas");
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const context = canvas.getContext("2d");
                    context.drawImage(video, 0, 0);
                    const imageDataUrl = canvas.toDataURL("image/png");

                    addImageToGallery(imageDataUrl); // Ajouter à la galerie et au champ de saisie
                    stream.getTracks().forEach(track => track.stop());
                    modal.remove();
                    showBootstrapToast('Image ajoutée avec succès !', 'success');
                };

                // Commencer l'enregistrement vidéo
                recordBtn.onclick = function () {
                    if (!mediaRecorder || mediaRecorder.state === "inactive") {
                        mediaRecorder = new MediaRecorder(stream);
                        recordedChunks = [];

                        mediaRecorder.ondataavailable = function (event) {
                            if (event.data.size > 0) {
                                recordedChunks.push(event.data);
                            }
                        };

                        // عند إيقاف التسجيل (تسجيل الفيديو)
                        mediaRecorder.onstop = function () {
                            const videoBlob = new Blob(recordedChunks, { type: 'video/mp4' });
                            const videoUrl = URL.createObjectURL(videoBlob);

                            addVideoToGallery(videoUrl); // إضافة الفيديو إلى المعرض
                            showBootstrapToast('Vidéo enregistrée avec succès !', 'success');

                            // إيقاف البث وإغلاق النافذة المنبثقة
                            stream.getTracks().forEach(track => track.stop());
                            modal.remove();
                        };


                        mediaRecorder.start();
                        recordBtn.innerText = "Arrêter l'enregistrement vidéo";
                    } else if (mediaRecorder.state === "recording") {
                        mediaRecorder.stop();
                        recordBtn.innerText = "Commencer l'enregistrement vidéo";
                    }
                };
            })
            .catch(function (error) {
                console.error("Erreur lors de l'accès à la caméra:", error);
            });
    }



    // Ensure the "Add Video" button works and opens the camera modal
    document.body.addEventListener('click', function (event) {
        if (event.target && event.target.classList.contains('take-video-btn')) {
            event.preventDefault();
            openCamera();
        }
    });
        
</script>
    
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var pathRegex = /^\/location\/\d+\/$/;
        
        if (pathRegex.test(window.location.pathname)) {
            var sidebarItemsLink = document.querySelector('a[href="#sidebarItems"]');
            var sidebarItemsCollapse = document.getElementById("sidebarItems");
            
            if (sidebarItemsLink && sidebarItemsCollapse) {
                sidebarItemsLink.setAttribute("aria-expanded", "true");
                sidebarItemsCollapse.classList.add("show");
            }
        }
    });
</script>


<script>

    document.addEventListener("DOMContentLoaded", function () {
        const toggleButton = document.getElementById("togglemenu");
        const logoText = document.getElementById("logo-text");
        const startbar = document.querySelector(".startbar");

        toggleButton.addEventListener("click", function () {
            const isCollapsed = startbar.classList.contains("collapsed");

            if (isCollapsed) {
                logoText.style.display = "inline";
            } else {
                logoText.style.display = "none";
            }

            startbar.classList.toggle("collapsed");
        });
    });
    

</script>


</body>
</html>
