{% load static %}
<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, viewport-fit=cover" />
    <title>Ajouter un nouveau projet</title>
    <link rel="stylesheet" type="text/css" href="{% static 'mobile/styles_mobile/bootstrap.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'mobile/fonts/bootstrap-icons.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{% static 'mobile/scripts_mobile/bootstrap.min.js' %}"></script>
    <script src="{% static 'mobile/scripts_mobile/custom.js' %}"></script>
    <link href="{% static 'web/assets/css/esri_main.css' %}" rel="stylesheet" type="text/css" />
    <script src="https://js.arcgis.com/4.30/"></script>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        #viewDiv {
            position: absolute;
            top: 0px;
            bottom: 0px;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 1;
        }

        #footer-bar {
            z-index: 10;
        }

        .esri-basemap-gallery__item-container {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }


    </style>
</head>
<body class="">
    
  {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm border-theme-white-2" role="alert">
        <div class="d-inline-flex justify-content-center align-items-center thumb-xs 
            {% if message.tags == 'success' %} bg-success
            {% elif message.tags == 'danger' %} bg-danger
            {% elif message.tags == 'warning' %} bg-warning
            {% elif message.tags == 'info' %} bg-purple
            {% else %} bg-secondary {% endif %} 
            rounded-circle mx-auto me-1">
            <i class="fas 
                {% if message.tags == 'success' %} fa-check
                {% elif message.tags == 'danger' %} fa-xmark
                {% elif message.tags == 'warning' %} fa-exclamation
                {% elif message.tags == 'info' %} fa-info
                {% else %} fa-info {% endif %}
                align-self-center mb-0 text-white"></i>
        </div>
        {{ message|safe }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
  {% endif %}
  <script>
    // Set a timeout to automatically close the alert after 15 seconds (15000 milliseconds)
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            alert.classList.remove('show');
            alert.classList.add('fade');
            setTimeout(function() {
                alert.remove();
            }, 500); // Delay for fade-out animation
        });
    }, 10000);
  </script>


                
            <!-- Container for Bootstrap Toasts -->
            <div class="toast-container position-absolute p-3 top-0 end-0" id="toastPlacement"></div>
            
            
            <!-- Modal pour ajouter un nouvel élément avec la capture de caméra -->
            <div class="modal fade" id="CreateItemModal" tabindex="-1" aria-labelledby="CreateItemModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-fullscreen-lg-down">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="CreateItemModalLabel">Créer un élément</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                        </div>
                        <form method="POST" action="{% url 'add_item_mobile' location.id %}" enctype="multipart/form-data">
                        <div class="modal-body">
                                {% csrf_token %}
                                <div class="form-group mb-3">
                                    <label for="itemName">Nom</label>
                                    <input type="text" class="form-control" id="itemName" name="name" placeholder="Nom" required />
                                </div>
                                <div class="form-group mb-3">
                                    <label for="itemDescription">Description</label>
                                    <textarea class="form-control" id="itemDescription" name="description" placeholder="Description" required></textarea>
                                </div>
                                <div class="form-group mb-3">
                                    <div class="image-gallery" name="images"></div>
                                    <button type="button" class="take-video-btn btn btn-warning mb-2">
                                        <i class="fas fa-camera"></i> Capturer une image/vidéo
                                    </button>
                                    <input type="file" class="form-control-file" name="media" id="imageInput" multiple accept="image/*,video/*" hidden />
                                </div>
                                <input type="hidden" name="geojson" id="geojsonInput" />
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Enregistrer</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                        </div>
                    </form>
                    </div>
                </div>
            </div>

            <!-- Modal pour afficher les détails d'un élément -->
            <div class="modal fade" id="viewItemModal" tabindex="-1" aria-labelledby="viewItemModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-fullscreen-lg-down">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="viewItemModalLabel">Détails de l'élément</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="viewItemName" class="form-control mb-2" placeholder="Nom" readonly />
                            <textarea id="viewItemDescription" class="form-control mb-3" placeholder="Description" readonly></textarea>
                            <div id="mediaCarousel" class="carousel slide" data-bs-ride="carousel" style="width: 100%; max-height: 400px;">
                                <div class="carousel-inner" id="carouselInner"></div>
                                <a class="carousel-control-prev" href="#mediaCarousel" role="button" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="sr-only">Précédent</span>
                                </a>
                                <a class="carousel-control-next" href="#mediaCarousel" role="button" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="sr-only">Suivant</span>
                                </a>
                            </div>
                            <div id="placeDetails" class="mt-3 text-center d-none">
                                <strong id="placeName"></strong><br>
                                <p id="placeDescription"></p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" id="editButton" class="btn btn-primary btn-sm d-none">Modifier</button>
                            <button type="button" class="btn btn-danger btn-sm d-none" id="deleteButton" >Supprimer</button>
                            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal pour modifier un élément -->
            <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-fullscreen-lg-down">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editModalLabel">Modifier l'élément</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                        </div>
                        <div class="modal-body">
                            <form id="edit-form" method="POST" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="hidden" id="edit-item-id" name="item_id">
                                <div class="form-group mb-3">
                                    <label for="edit-name">Nom :</label>
                                    <input type="text" class="form-control" id="edit-name" name="name" required>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="edit-description">Description :</label>
                                    <textarea class="form-control" id="edit-description" name="description" required></textarea>
                                </div>
                                <div class="form-group mb-3">
                                    <button type="button" class="take-video-btn btn btn-warning mb-2">
                                        <i class="fas fa-camera"></i> Bouton de capture
                                    </button>
                                    <input type="file" name="media" id="imageInput" multiple accept="image/*,video/*" class="form-control-file" hidden />
                                    <div class="image-gallery mt-3" name="images"></div>
                                </div>
                                <input type="hidden" id="edit-geojson" name="geojson">
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Enregistrer</button>
                            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fermer</button>
                        </div>
                    </div>
                </div>
            </div>


    <div id="page">
        <!-- القائمة السفلية -->
        <div id="footer-bar" class="footer-bar-1 footer-bar-detached">
            <a href="//"><i class="bi bi-pin-map"></i><span>Projets</span></a>
            <a href="page-activity.html"><i class="bi bi-map"></i><span>Rapports</span></a>
            <a href="/map_mobile/" class="circle-nav-2"><i class="bi bi-house-fill"></i><span>Tableau de bord</span></a>
            <a href="page-payments.html"><i class="bi bi-receipt"></i><span>Gérer les Médias</span></a>
            <a href="#" data-bs-toggle="offcanvas" data-bs-target="#menu-sidebar"><i class="bi bi-three-dots"></i><span>Plus</span></a>
        </div>

        <div id="viewDiv"></div>



    </div>



    


    <script>
    
  require([
  "esri/Map",
  "esri/views/MapView",
  "esri/layers/GraphicsLayer",
  "esri/widgets/Sketch/SketchViewModel",
  "esri/widgets/Sketch",
  "esri/widgets/Search",
  "esri/widgets/Expand",
  "esri/widgets/BasemapGallery",
  "esri/widgets/Fullscreen",
  "esri/Basemap",
  "esri/Graphic",
  "esri/geometry/Point",
  "esri/geometry/Polygon",
  "esri/geometry/Polyline"
], function(Map, MapView, GraphicsLayer, SketchViewModel, Sketch, Search, Expand, BasemapGallery, Fullscreen, Basemap, Graphic, Point, Polygon, Polyline) {
    
      // التأكد من إنشاء الطبقات مع أسماء محددة
      const graphicsLayer = new GraphicsLayer({ title: "Existing Features Layer" });
      const sketchLayer = new GraphicsLayer({ title: "New Features Layer" });
  
      const map = new Map({
          basemap: "satellite",
          layers: [graphicsLayer, sketchLayer]
      });
  
      const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [-6.8498, 34.0209],
          zoom: 15,
          ui: { components: ["zoom"] }
      });
  
      // Load GeoJSON data from Django template

      // Load GeoJSON data from Django template
      const locationGeoJSON = JSON.parse(`{{ location_geojson|escapejs }}`);
      const itemsGeoJSON = JSON.parse(`{{ items_geojson|escapejs }}`);

      function addGeoJSONToMap(geojson, shouldZoom = false) {
          if (geojson && geojson.geometry) {
              let graphicGeometry;
              let symbol;
      
              if (geojson.geometry.rings) {
                  graphicGeometry = new Polygon({
                      rings: geojson.geometry.rings,
                      spatialReference: geojson.geometry.spatialReference
                  });
                  symbol = {
                      type: "simple-fill",
                      color: [19, 23, 44, 0.5], // لون بنفسجي مع شفافية 0
                      outline: {
                          color: [255, 165, 0], // لون الحدود برتقالي
                          width: 2
                      }
                  };

              } else if (geojson.geometry.paths) {
                  graphicGeometry = new Polyline({
                      paths: geojson.geometry.paths,
                      spatialReference: geojson.geometry.spatialReference
                  });
                  symbol = {
                      type: "simple-line",
                      color: [255, 165, 0], // لون أخضر زاهي
                      width: 2,
                      style: "solid", // خط ثابت غير متقطع
                  };

              } else if (geojson.geometry.x && geojson.geometry.y) {
                  graphicGeometry = new Point({
                      x: geojson.geometry.x,
                      y: geojson.geometry.y,
                      spatialReference: geojson.geometry.spatialReference
                  });
                  symbol = {
                      type: "simple-marker",
                      style: "circle",
                      color: [19,23,44, 0.95], // لون سماوي للنقاط
                      size: "13px",
                      outline: {
                          color: [255, 165, 0], // لون الحدود برتقالي
                          width: 2
                      }
                  };
              }
      
              const graphic = new Graphic({
                  geometry: graphicGeometry,
                  symbol: symbol,
                  attributes: {
                      id: geojson.properties?.id || "",
                      name: geojson.properties?.name || "عنصر بدون اسم",
                      description: geojson.properties?.description || "لا توجد تفاصيل.",
                      media: geojson.properties?.media || "لا توجد ميديا."
                  }
              });
      
              if (!shouldZoom) {
                  graphicsLayer.add(graphic);
              }
      
              if (shouldZoom) {
                  view.when(() => {
                      const targetGeometry = graphicGeometry.extent ? graphicGeometry.extent.expand(1.5) : graphicGeometry;
                      view.goTo({
                          target: targetGeometry,
                          zoom: 14
                      }, {
                          animate: !!graphicGeometry.extent
                      }).catch((error) => {
                          console.error("Error in goTo operation: ", error);
                      });
                  });
              }
          } else {
              console.error("Invalid or missing GeoJSON data.");
          }
      };
      

      // Display itemsGeoJSON on the map
      itemsGeoJSON.features.forEach(feature => addGeoJSONToMap(feature, false));

      // Use locationGeoJSON for zoom, but do not add it to the map
      addGeoJSONToMap(locationGeoJSON, true);

      const snappingLayer = graphicsLayer;

      const sketchViewModel = new SketchViewModel({
          view: view,
          layer: graphicsLayer,
          snappingOptions: {
              enabled: true,
              featureEnabled: true,
              selfEnabled: true,
              featureSources: [{ layer: graphicsLayer }]
          },
          // تخصيص الألوان للبوليغون
          polygonSymbol: {
              type: "simple-fill", 
              color: [19,23,44, 0.5],
              outline: {
              color: [255, 165, 0],
              width: 2,
          }
          },
          // تخصيص الألوان للخطوط
          polylineSymbol: {
              type: "simple-line",
              color: [255, 165, 0],
              width: 2,
          },
          // تخصيص الألوان للنقاط
          pointSymbol: {
              type: "simple-marker",
              style: "circle",
              color: [19,23,44, 0.95],
              size: "13px",
              outline: {
                color: [255, 165, 0],
                width: 2
              }
          },
                  
          activeLineSymbol: {
              type: "simple-line", // Active drawing symbol
              color: [19,23,44],  // Green color for the polyline during active drawing
              width: 2,
              style: "solid"  // Make sure the line style is solid, no dashed line
          },

      });
      
      const sketch = new Sketch({
          view: view,
          layer: graphicsLayer,
          viewModel: sketchViewModel,
          layout: "vertical",
      
          snappingOptions: {
              enabled: true, // تفعيل الـ snapping
              featureEnabled: true,
              selfEnabled: true,
              featureSources: [
                  { layer: graphicsLayer, enabled: true, title: "Existing Features Layer" },
                  { layer: sketchLayer, enabled: true, title: "New Features Layer" }  // تأكد من وجود هذه الطبقة
              ]
          },
          defaultUpdateOptions: {
              tool: "reshape",  // تفعيل أداة reshape
              enableRotation: true,
              enableScaling: true,
              multipleSelectionEnabled: true,
              preserveAspectRatio: false,
              reshapeOptions: {
                  reshapeHandle: "vertices",
                  reshapeMode: "all"  // تعديل كافة الأجزاء
              }
          },
          defaultCreateOptions: {
              tool: "polyline",
              enableGuide: true,
              tooltipOptions: { enabled: true }
          },
      });
      

  // تفعيل عرض التولتيب بشكل افتراضي
  sketch.tooltipOptions.enabled = true;
      
      // إضافة حدث لإنشاء العنصر إلى أداة الـ Sketch
      sketch.on("create", event => {
          if (event.state === "complete") {
              activeGraphic = event.graphic; // تخزين العنصر المرسوم كعنصر نشط
              openCreateItemModal(event.graphic.toJSON()); // فتح نافذة لإضافة التفاصيل بعد الانتهاء من الرسم
          }
      });
  
      
      function updateGraphicOnServer(itemId, geojsonData, updatedGraphic) {
          // بناء كائن GeoJSON كامل
          const completeGeoJSON = {
              aggregateGeometries: null,
              geometry: geojsonData,
              symbol: {
                  type: "esriSLS",
                  color: [130, 130, 130, 255],
                  width: 1.5,
                  style: "esriSLSSolid"
              },
              attributes: {},
              popupTemplate: null
          };
  
          fetch(`/item_mobile/${itemId}/update/`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': '{{ csrf_token }}'
              },
              body: JSON.stringify({
                  geojson: completeGeoJSON
              })
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  showBootstrapToast('L\'élément a été mis à jour avec succès!', "success");
  
                  sketchLayer.remove(updatedGraphic);
                  graphicsLayer.add(updatedGraphic);
              } else {
                  showBootstrapToast('Erreur lors de la mise à jour de l\'élément: ' + data.message, "danger");
              }
          })
          .catch(error => {
              console.error('Error:', error);
              showBootstrapToast('Une erreur s\'est produite lors de l\'envoi de la demande.', "danger");
          });
      }
  
      const fullscreen = new Fullscreen({
          view: view 
      });

      view.ui.add(fullscreen, "top-right");

      const searchWidget = new Search({
          view: view,
          allPlaceholder: "Search for a place",
          locationEnabled: true,
      });

      const searchExpand = new Expand({
          view: view,
          content: searchWidget,
          expandIconClass: "esri-icon-search", // أيقونة البحث
          expandTooltip: "Click to search", // نص الإرشاد عند تمرير الفأرة
          expanded: false, // تأكد من أنه غير مفعل تلقائيًا حتى يظهر فقط عند 
          mode: "floating"
      });
  
      
      const basemapGallery = new BasemapGallery({
          view: view
      });
  
      // استخدام عنصر Expand لعرض BasemapGallery بشكل أفضل
      const basemapExpand = new Expand({
          view: view,
          content: basemapGallery,
          expandIconClass: "esri-icon-basemap", // أيقونة خريطة أساس
          expandTooltip: "Toggle Basemap Gallery" // نص توضيحي يظهر عند تمرير الماوس
      });
  
  
      // نقل أداة التكبير والتصغير إلى الأعلى اليسار
      view.ui.move("zoom", "top-right");
  

      
      const sketchExpand = new Expand({
        view: view,
        content: sketch,
        expandIconClass: "esri-icon-sketch",
        expandTooltip: "Click to draw",
        expanded: false, 
        mode: "floating"
      });
    
      // إضافة عنصر Expand الخاص بـ Sketch إلى واجهة المستخدم
      view.ui.add(sketchExpand, {
          position: "top-left",
          index: 1 
      });
      
    
      // إضافة عنصر Expand إلى واجهة المستخدم في الموضع المطلوب
      view.ui.add(basemapExpand, {
          position: "top-right"
      });
  
      // إضافة أداة Expand إلى واجهة المستخدم مع أداة البحث
      view.ui.add(searchExpand, {
          position: "top-right",
          index: 2 // ترتيب أعلى بقليل من أداة التكبير وأداة الرسم
      });
  
  
      function addShowInfoButton() {
          // استهداف قسم الأزرار في أداة Sketch
          const infoSection = document.querySelector('.esri-sketch__section.esri-sketch__info-section');
          
          // التأكد من أن القسم موجود ولم يتم إضافة الزر سابقًا
          if (infoSection && !infoSection.querySelector('.custom-show-info-button')) {
              // إنشاء زر "Show Information" جديد
              const showInfoButton = document.createElement("calcite-action");
              showInfoButton.setAttribute("title", "Show Information");
              showInfoButton.setAttribute("appearance", "solid");
              showInfoButton.setAttribute("scale", "s");
              showInfoButton.classList.add('custom-show-info-button'); // كلاس مميز للزر
              showInfoButton.innerHTML = `<calcite-icon icon="information" scale="s"></calcite-icon>`;
  
              // إضافة الزر بعد زر "Duplicate" إذا كان موجودًا
              const duplicateButton = infoSection.querySelector('calcite-action[title="Duplicate feature"]');
              if (duplicateButton) {
                  duplicateButton.parentNode.insertBefore(showInfoButton, duplicateButton.nextSibling);
              } else {
                  // إذا لم يكن الزر موجودًا، نضيفه في نهاية القسم
                  infoSection.appendChild(showInfoButton);
              }
  
              // إضافة حدث للنقر على زر "Show Information"
              showInfoButton.addEventListener('click', () => {
                  if (window.selectedGraphic) {
                      const attributes = window.selectedGraphic.attributes || {};
                      const media = attributes.media || []; // الميديا
                      openViewItemModal(attributes.name, attributes.description, media); // عرض المودال
                  } else {
                      alert('No selected graphic to show information.');
                  }
              });
          }
      }
  
  
      // وظيفة لإستبدال زر التكرار بزر الحفظ إذا لم يكن قد أُضيف بعد
      function updateDuplicateButtonWithSave() {
          const duplicateButton = document.querySelector('calcite-action[title="Duplicate feature"]');
          if (duplicateButton && !duplicateButton.dataset.customSaveAdded) {
              const customSaveButton = duplicateButton.cloneNode(true);
              duplicateButton.style.display = 'none'; // إخفاء الزر القديم
  
              // إعداد خصائص الزر المخصص
              customSaveButton.setAttribute('title', 'Save feature');
              customSaveButton.innerHTML = ''; 
              customSaveButton.setAttribute('scale', 's');
              customSaveButton.setAttribute('appearance', 'solid');
  
              const icon = document.createElement('calcite-icon');
              icon.setAttribute('icon', 'save'); // استخدام أيقونة الحفظ
              icon.setAttribute('scale', 's');
              customSaveButton.appendChild(icon);
  
              // إضافة حدث الحفظ
              customSaveButton.addEventListener('click', () => {
                  if (window.selectedGraphic && window.selectedGraphic.attributes) {
                      const itemId = window.selectedGraphic.attributes.id;
                      saveItem(itemId); // دالة الحفظ المخصصة
                  } else {
                      alert("No selected graphic to save.");
                  }
              });
  
              // استبدال زر "Duplicate" بالزر المعدل
              duplicateButton.parentNode.appendChild(customSaveButton);
              duplicateButton.dataset.customSaveAdded = "true"; // منع إضافة الزر مرة أخرى
          }
      }
  
      // دالة الحفظ المخصصة
      function saveItem(itemId) {
          const updatedGraphic = window.selectedGraphic;
  
          if (!updatedGraphic) {
              alert("لا يوجد عنصر محدد للحفظ.");
              return;
          }
  
          const updatedGeoJSON = updatedGraphic.geometry ? updatedGraphic.geometry.toJSON() : null;
  
          if (updatedGeoJSON) {
              // استدعاء الدالة لحفظ البيانات على الخادم
              updateGraphicOnServer(itemId, updatedGeoJSON, updatedGraphic);
          } else {
              console.error('GeoJSON غير صالح أو غير متوفر.');
          }
      }
  
      // وظيفة لاستبدال زر الحذف إذا لم يكن قد أُضيف بعد
      function updateDeleteButton() {
          const deleteButton = document.querySelector('calcite-action[title="Delete feature"]');
          if (deleteButton && !deleteButton.dataset.customDeleteAdded) {
              const customDeleteButton = deleteButton.cloneNode(true);
              deleteButton.style.display = 'none'; // إخفاء الزر القديم
  
              // إعداد مظهر الزر المخصص
              customDeleteButton.setAttribute('title', 'Custom Delete feature');
              customDeleteButton.innerHTML = ''; 
              customDeleteButton.setAttribute('scale', 's');
              customDeleteButton.setAttribute('appearance', 'solid');
  
              const icon = document.createElement('calcite-icon');
              icon.setAttribute('icon', 'trash'); // استخدام أيقونة الحذف
              icon.setAttribute('scale', 's');
              customDeleteButton.appendChild(icon);
  
              // إضافة الحدث إلى الزر المخصص
              customDeleteButton.addEventListener('click', () => {
                  if (window.selectedGraphic && window.selectedGraphic.attributes) {
                      const itemId = window.selectedGraphic.attributes.id;
                      window.deleteItem(itemId); // استخدام دالة الحذف المخصصة
                  } else {
                      alert('No selected graphic to delete.');
                  }
              });
  
              // إضافة الزر المخصص بعد الزر الأصلي
              deleteButton.parentNode.appendChild(customDeleteButton);
              deleteButton.dataset.customDeleteAdded = "true"; // منع إضافة الزر مرة أخرى
          }
      }
  
      // إنشاء MutationObserver لمراقبة DOM
      const observer = new MutationObserver((mutationsList, observer) => {
          // إيقاف المراقب مؤقتاً لتجنب الدخول في حلقة لانهائية
          observer.disconnect();
  
          // تحديث الأزرار في كل مرة يتغير فيها الـ DOM
          updateDuplicateButtonWithSave(); // استبدال زر التكرار بزر الحفظ
          updateDeleteButton(); // استبدال زر الحذف بزره المخصص
          addShowInfoButton(); // إضافة زر عرض المعلومات
  
          // إعادة تفعيل المراقب بعد إجراء التغييرات
          observer.observe(document.body, { childList: true, subtree: true });
      });
  
      // بدء مراقبة DOM للتأكد من اكتشاف التغييرات
      observer.observe(document.body, { childList: true, subtree: true });
  
      // Event listener for single-click (select item and store in a variable)
      view.on("click", function(event) {
          view.hitTest(event).then(function(response) {
              const graphic = response.results.find(result => result.graphic.layer === graphicsLayer || result.graphic.layer === sketchLayer);
  
              if (graphic) {
                  const clickedGraphic = graphic.graphic;
                  window.selectedGraphic = clickedGraphic; // تخزين العنصر المحدد في المتغير العالمي
  
                  const attributes = clickedGraphic.attributes || {};
                  const media = attributes.media || []; // الحصول على الميديا من البيانات
                  const id = attributes.id || 'undefined-id'; // التأكد من أن الـ ID موجود

                  // تجهيز زر التعديل بالمعلومات المطلوبة لفتح نموذج التعديل عند النقر عليه
                  const editButton = document.getElementById('editButton');
                  
                  // إزالة أي حدث قديم من الزر لتجنب التكرارات
                  editButton.removeEventListener('click', handleEditButtonClick);
                  
                  // إنشاء دالة لمعالجة النقر على زر التعديل
                  function handleEditButtonClick() {
                      openEditModal(id, attributes.name, attributes.description, JSON.stringify(clickedGraphic.geometry.toJSON()));
                  }
                  
                  // إضافة حدث جديد إلى الزر باستخدام `addEventListener`
                  editButton.addEventListener('click', handleEditButtonClick);
  
                  // تجهيز زر الحذف بالمعلومات المطلوبة لحذف العنصر عند النقر عليه
                  const deleteButton = document.getElementById('deleteButton');
                  
                  // إزالة أي حدث قديم من الزر لتجنب التكرارات
                  deleteButton.removeEventListener('click', handleDeleteButtonClick);
                  
                  // إنشاء دالة لمعالجة النقر على زر الحذف
                  function handleDeleteButtonClick() {
                      deleteItem(id);
                  }
  
                  // إضافة حدث جديد إلى الزر باستخدام `addEventListener`
                  deleteButton.addEventListener('click', handleDeleteButtonClick);
  
              } else {
                  window.selectedGraphic = null; // إذا لم يتم تحديد عنصر، إفراغ المتغير
              }
          });
      });
  

      // Event listener for double-click to enable advanced editing of an existing graphic
      view.on("double-click", function (event) {
          event.stopPropagation(); // Prevent default double-click zoom behavior

          view.hitTest(event).then(function (response) {
              const graphic = response.results.find(result => result.graphic.layer === graphicsLayer || result.graphic.layer === sketchLayer);

              if (graphic) {
                  const clickedGraphic = graphic.graphic;
                  if (clickedGraphic.layer === graphicsLayer) {
                      // Move the graphic to the sketch layer to allow full editing capabilities
                      const clonedGraphic = clickedGraphic.clone();
                      graphicsLayer.remove(clickedGraphic); // Remove the graphic from the original layer
                      sketchLayer.add(clonedGraphic); // Add the graphic to the sketch layer

                      // Ensure the graphic has been added to the sketch layer before updating
                      if (sketchLayer.graphics.includes(clonedGraphic)) {
                          // Activate full editing mode for the graphic (reshape, move, add/remove parts)
                          sketch.update({
                              tool: "reshape", // Enable advanced editing with reshape tool
                              graphics: [clonedGraphic],
                              enableScaling: true,
                              enableRotation: true,
                              preserveAspectRatio: false, // Allow freeform reshaping
                              toggleToolOnClick: false, // Keep tool active for continuous editing
                              enableReshape: true, // Enable reshaping parts of geometry
                              reshapeOptions: {
                                  reshapeHandle: "vertices", // Allow editing vertices (for polygons/lines)
                                  reshapeMode: "all" // Enable reshape for all parts (lines, polygons)
                              }
                          });
                      }
                  } else if (clickedGraphic.layer === sketchLayer) {
                      // If already in the sketch layer, directly activate the reshape tool to edit
                      if (sketchLayer.graphics.includes(clickedGraphic)) {
                          sketch.update({
                              tool: "reshape",
                              graphics: [clickedGraphic],
                              enableScaling: true,
                              enableRotation: true,
                              preserveAspectRatio: false,
                              toggleToolOnClick: false,
                              enableReshape: true,
                              reshapeOptions: {
                                  reshapeHandle: "vertices",
                                  reshapeMode: "all"
                              }
                          });
                      }
                  }
              }
          });
      });

  
      // Function to show the Create Item Modal
      window.openCreateItemModal = function(geojson) {
          // تحديث قيمة الحقل المخفي للـ GeoJSON
          document.getElementById('geojsonInput').value = JSON.stringify(geojson);
          
          // استخدام Bootstrap لإظهار المودال
          $('#CreateItemModal').modal('show'); // إظهار المودال باستخدام Bootstrap's JavaScript API
      };
  
      // Function to close the Create Item Modal using Bootstrap's modal API
      window.closeCreateItemModal = function() {
          $('#CreateItemModal').modal('hide'); // Hide the modal using Bootstrap's API
      };
  
      // Event listener to handle the removal of the active graphic when the modal is fully hidden
      $('#CreateItemModal').on('hidden.bs.modal', function () {
          // Remove the active graphic from the graphics layer if it exists
          if (activeGraphic && graphicsLayer) {
              graphicsLayer.remove(activeGraphic);
              activeGraphic = null; // Reset the activeGraphic variable after removal
          }
      });
  
  
  
      window.openViewItemModal = function(name, description, media) {
          // تحديث اسم المكان والوصف في الـ modal
          document.getElementById('viewItemName').value = name || "Pas de nom";
          document.getElementById('viewItemDescription').value = description || "Aucun détail";
  
          // تحديث اسم المكان والوصف في قسم معلومات المكان
          document.getElementById('placeName').innerText = name || "Pas de nom";
          document.getElementById('placeDescription').innerText = description || "Aucun détail";
  
          // تحديث محتوى السلايدر
          const carouselInner = document.getElementById('carouselInner');
          carouselInner.innerHTML = ''; // تنظيف المحتوى السابق للسلايدر
  
          if (Array.isArray(media) && media.length > 0) {
              media.forEach((item, index) => {
                  const carouselItem = document.createElement('div');
                  carouselItem.className = `carousel-item ${index === 0 ? 'active' : ''}`;
  
  
                  // إضافة المحتوى بناءً على نوع الميديا (صورة أو فيديو)
                  const mediaContent = item.file_type === 'image'
                      ? `<img src="${item.file_url}" class="d-block w-100" alt="Media Image" style="max-height: 200px;">`
                      : `<video controls class="d-block w-100" style="width: 100%;max-height: 400px;box-shadow: 1px 1px 5px 1px #eee;border-radius: 4px;">
                          <source src="${item.file_url}" type="video/mp4">
                      </video>`;
  
                  // إضافة أزرار التعديل والحذف للميديا
                  const mediaControls = `
                      <div class="carousel-caption d-flex justify-content-center align-items-center flex-nowrap">
                          <!-- زر التعديل -->
                          <form method="POST" action="/media/${item.id}/update/" enctype="multipart/form-data" class="d-inline-flex">
                              {% csrf_token %}
                              <input type="file" name="media_file" accept="image/*,video/*" style="display:none;" id="mediaInput${item.id}">
                              <button type="button" class="btn btn-warning btn-sm me-2 w-100" onclick="document.getElementById('mediaInput${item.id}').click();">Importer</button>
                              <button type="submit" class="btn btn-primary btn-sm me-2 w-100">Modifier</button>
                          </form>
                          <!-- زر الحذف -->
                          <form method="POST" action="/media/${item.id}/delete/" class="d-inline-flex">
                              {% csrf_token %}
                              <button type="submit" class="btn btn-danger btn-sm w-100">Supprimer</button>
                          </form>
                      </div>`;

                carouselItem.innerHTML = mediaContent ; // + mediaControls;
                  carouselInner.appendChild(carouselItem);
              });
          } else {
              const noMediaMessage = document.createElement('div');
              noMediaMessage.className = 'carousel-item active';
              noMediaMessage.innerHTML = '<p class="text-center">Il n\'y a aucun média à afficher.</p>';
              carouselInner.appendChild(noMediaMessage);
          }
  
          // عرض المودال
          $('#viewItemModal').modal('show');
      };
  
      window.closeViewItemModal = function() {
          $('#viewItemModal').modal('hide'); // إغلاق المودال باستخدام Bootstrap API
      };
  
      window.openEditModal = function(itemId, name, description, geojsonStr) {
          try {
              // التحقق مما إذا كانت geojsonStr معرفة وليست فارغة
              let geojson;
              if (geojsonStr) {
                  // تحويل geojsonStr إلى كائن JavaScript
                  geojson = JSON.parse(geojsonStr.replace(/&quot;/g, '"'));
                  document.getElementById('edit-geojson').value = JSON.stringify(geojson);
              } else {
                  console.warn('geojsonStr is undefined or empty');
                  document.getElementById('edit-geojson').value = '';
              }
  
              // إعداد البيانات داخل المودال
              document.getElementById('edit-name').value = name || '';
              document.getElementById('edit-description').value = description || '';
              document.getElementById('edit-item-id').value = itemId;
  
              // تعديل عنوان الـ form ليتوافق مع العملية المطلوبة
              document.getElementById('edit-form').action = `/item_mobile/${itemId}/update/`;
  
              // عرض المودال باستخدام Bootstrap
              $('#editModal').modal('show');
          } catch (error) {
              console.error('خطأ في geojsonStr:', geojsonStr, error);
              showBootstrapToast('Une erreur s \'est produite lors du traitement des données. Assurez-vous que les valeurs sont correctes.', 'danger');
          }
      };
  
      window.deleteItem = function(itemId) {
          if (confirm("Êtes-vous sûr de vouloir supprimer cet élément ?")) {
              fetch(`/item/${itemId}/delete/`, {
                  method: 'POST',
                  headers: {
                      'X-CSRFToken': '{{ csrf_token }}'
                  }
              })
              .then(response => response.json())
              .then(data => {
                  if (data.success) {
                      showBootstrapToast('L\'élément a été supprimé avec succès!', "success");
                      location.reload();
                  } else {
                      showBootstrapToast('Erreur lors de la suppression de l\'élément: ' + data.message, "danger");
                  }
              })
              .catch(error => {
                  console.error('Error:', error);
                  showBootstrapToast('Une erreur s\'est produite lors de l\'envoi de la demande.', "danger");
              });
          }
      };
  
  });
  
  
  // Function to show toast notifications
  function showBootstrapToast(message, type) {
      var toastHTML = `
          <div class="toast fade show" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="toast-header">
                  <img src="assets/images/logo-sm.png" alt="" height="20" class="me-1">
                  <strong class="me-auto">Rizz</strong>
                  <small>Just now</small>
                  <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
              <div class="toast-body">
                  ${message}
              </div>
          </div>
      `;
      
      var toastContainer = document.getElementById('toastPlacement');
      if (!toastContainer) {
          // Create toast container if it doesn't exist
          toastContainer = document.createElement('div');
          toastContainer.id = 'toastPlacement';
          toastContainer.className = 'toast-container position-absolute p-3 top-0 end-0';
          document.body.appendChild(toastContainer);
      }
      
      // Append the new toast
      toastContainer.insertAdjacentHTML('beforeend', toastHTML);

      // Initialize and show the toast
      var toastElement = toastContainer.lastElementChild;
      var bootstrapToast = new bootstrap.Toast(toastElement);
      bootstrapToast.show();

      // Automatically remove the toast after it's hidden
      toastElement.addEventListener('hidden.bs.toast', function () {
          toastElement.remove();
      });
  }

  
  function uploadChunkedFile(file, url, chunkSize = 5 * 1024 * 1024) {
      let start = 0;
      let chunkIndex = 0;
  
      while (start < file.size) {
          const chunk = file.slice(start, start + chunkSize);
          const formData = new FormData();
          formData.append('chunk', chunk);
          formData.append('file_name', file.name);
          formData.append('chunk_index', chunkIndex);
  
          // رفع الجزء إلى الخادم
          fetch(url, {
              method: 'POST',
              body: formData,
              headers: {
                  'X-CSRFToken': '{{ csrf_token }}'
              }
          })
          .then(response => response.json())
          .then(data => {
              console.log(`Chunk ${chunkIndex} uploaded successfully.`);
          })
          .catch(error => {
              console.error('Error uploading chunk:', error);
          });
  
          start += chunkSize;
          chunkIndex++;
      }
  }
  
  function compressImage(file, maxWidth = 800, maxHeight = 800) {
      const img = new Image();
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
  
      img.src = URL.createObjectURL(file);
      img.onload = function() {
          const ratio = Math.min(maxWidth / img.width, maxHeight / img.height);
          canvas.width = img.width * ratio;
          canvas.height = img.height * ratio;
  
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          canvas.toBlob(function(blob) {
              const compressedFile = new File([blob], file.name, { type: 'image/jpeg' });
              addMediaToInput(compressedFile);
          }, 'image/jpeg', 0.8);  // جودة الصورة بعد الضغط
      };
  }
  
  // Function to add media files (image/video) to the input field and the gallery
  function addMediaToInput(file) {
      const input = document.getElementById("imageInput");
      const dataTransfer = new DataTransfer();
  
      // Add existing files back to the input
      if (input.files.length > 0) {
          for (let i = 0; i < input.files.length; i++) {
              dataTransfer.items.add(input.files[i]);
          }
      }
  
      // Add the new file to the input
      dataTransfer.items.add(file);
      input.files = dataTransfer.files;
  }
  
  // Function to convert DataURL to File
  function dataURLtoFile(dataurl, filename, mimeType) {
      const arr = dataurl.split(',');
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) {
          u8arr[n] = bstr.charCodeAt(n);
      }
      return new File([u8arr], filename, { type: mimeType });
  }
  
  // Function to remove file from input
  function removeFileFromInput(fileName) {
      const input = document.getElementById("imageInput");
      const dataTransfer = new DataTransfer();
  
      // Add only the files that don't match the filename to the DataTransfer object
      for (let i = 0; i < input.files.length; i++) {
          if (input.files[i].name !== fileName) {
              dataTransfer.items.add(input.files[i]);
          }
      }
  
      // Update the input with the remaining files
      input.files = dataTransfer.files;
  }
  
  let imageCount = 1;  // لتعداد الصور
  let videoCount = 1;  // لتعداد الفيديوهات
  
  // Fonction pour ajouter une image à la galerie et à l'input
  function addImageToGallery(imageDataUrl) {
      const gallery = document.querySelector(".image-gallery");
      const div = document.createElement("div");
      div.className = "image-item col-md-6";  // Divise les éléments en 2 colonnes (6/12)
  
      const img = document.createElement("img");
      img.src = imageDataUrl;
      img.style.width = '100%';
      img.style.height = 'auto';
  
      const fileName = `{{ location.name }}-image-${imageCount}.png`;  // استخدم اسم الـ location مع تسلسل رقمي
      imageCount++;  // زيادة العدد لتسلسل الصور
  
      const removeBtn = document.createElement("button");
      removeBtn.className = "btn btn-danger btn-sm mt-2";
      removeBtn.innerText = "Supprimer";
      removeBtn.onclick = function () {
          div.remove();  // Supprimer de la galerie
          removeFileFromInput(fileName);  // Supprimer de l'input
      };
  
      div.appendChild(img);
      div.appendChild(removeBtn);
      gallery.appendChild(div);
  
      // Convertir l'URL de données de l'image en fichier et l'ajouter à l'input
      const imageFile = dataURLtoFile(imageDataUrl, fileName, "image/png");
      addMediaToInput(imageFile);
  }
  
  // Fonction pour ajouter une vidéo à la galerie et à l'input
  function addVideoToGallery(videoUrl) {
      const gallery = document.querySelector(".image-gallery");
      const div = document.createElement("div");
      div.className = "image-item col-md-6";  // Divise les éléments en 2 colonnes (6/12)
  
      const videoElement = document.createElement("video");
      videoElement.controls = true;
      videoElement.src = videoUrl;
      videoElement.style.width = '100%';
      videoElement.style.height = 'auto';
      div.appendChild(videoElement);
  
      const fileName = `{{ location.name }}-video-${videoCount}.mp4`;  // استخدم اسم الـ location مع تسلسل رقمي
      videoCount++;  // زيادة العدد لتسلسل الفيديوهات
  
      const removeBtn = document.createElement("button");
      removeBtn.className = "btn btn-danger btn-sm mt-2";
      removeBtn.innerText = "Supprimer";
      removeBtn.onclick = function () {
          div.remove();  // Supprimer de la galerie
          removeFileFromInput(fileName);  // Supprimer de l'input
      };
  
      div.appendChild(removeBtn);
      gallery.appendChild(div);
  
      // Convertir l'URL de la vidéo en Blob puis en fichier, et l'ajouter à l'input
      fetch(videoUrl)
          .then(res => res.blob())
          .then(blob => {
              const videoFile = new File([blob], fileName, { type: "video/mp4" });
              addMediaToInput(videoFile);
          });
  }
  
  // Fonction pour ouvrir la caméra pour capturer des images ou enregistrer des vidéos
  function openCamera() {
      const modal = document.createElement("div");
      modal.className = "camera-modal";
  
      // Configuration CSS pour la réactivité
      modal.style.position = 'fixed';
      modal.style.top = '50%';
      modal.style.left = '50%';
      modal.style.transform = 'translate(-50%, -50%)'; // Centrer les éléments
      modal.style.width = '90%'; // Largeur à 90% pour les petits écrans
      modal.style.maxWidth = '300px'; // Largeur maximale pour les grands écrans
      modal.style.height = 'auto';
      modal.style.background = 'rgba(0, 0, 0, 0.7)';
      modal.style.padding = '10px';
      modal.style.borderRadius = '10px';
      modal.style.boxShadow = '0px 4px 10px rgba(0,0,0,0.5)';
      modal.style.zIndex = '9000';
      document.body.appendChild(modal);
  
      const video = document.createElement("video");
      video.autoplay = true;
      video.style.width = '100%'; // Pleine largeur de la vidéo
      video.style.height = 'auto';
      video.style.borderRadius = '5px';
      modal.appendChild(video);
  
      const captureBtn = document.createElement("button");
      captureBtn.innerText = "Capturer une image";
      captureBtn.className = "btn btn-primary mt-2";
      captureBtn.style.width = '100%'; // Pleine largeur du bouton
      modal.appendChild(captureBtn);
  
      const recordBtn = document.createElement("button");
      recordBtn.innerText = "Commencer l'enregistrement vidéo";
      recordBtn.className = "btn btn-warning mt-2";
      recordBtn.style.width = '100%'; // Pleine largeur du bouton
      modal.appendChild(recordBtn);
  
      const closeBtn = document.createElement("button");
      closeBtn.innerText = "Fermer";
      closeBtn.className = "btn btn-danger mt-2";
      closeBtn.style.width = '100%'; // Pleine largeur du bouton
      closeBtn.onclick = function () {
          modal.remove();
      };
      modal.appendChild(closeBtn);
  
      let mediaRecorder;
      let recordedChunks = [];
  
      // Accéder à la caméra arrière
      navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } })
          .then(function (stream) {
              video.srcObject = stream;
  
              // Capturer une image
              captureBtn.onclick = function () {
                  const canvas = document.createElement("canvas");
                  canvas.width = video.videoWidth;
                  canvas.height = video.videoHeight;
                  const context = canvas.getContext("2d");
                  context.drawImage(video, 0, 0);
                  const imageDataUrl = canvas.toDataURL("image/png");
  
                  addImageToGallery(imageDataUrl); // Ajouter à la galerie et au champ de saisie
                  stream.getTracks().forEach(track => track.stop());
                  modal.remove();
                  showBootstrapToast('Image ajoutée avec succès !', 'success');
              };
  
              // Commencer l'enregistrement vidéo
              recordBtn.onclick = function () {
                  if (!mediaRecorder || mediaRecorder.state === "inactive") {
                      mediaRecorder = new MediaRecorder(stream);
                      recordedChunks = [];
  
                      mediaRecorder.ondataavailable = function (event) {
                          if (event.data.size > 0) {
                              recordedChunks.push(event.data);
                          }
                      };
  
                      // عند إيقاف التسجيل (تسجيل الفيديو)
                      mediaRecorder.onstop = function () {
                          const videoBlob = new Blob(recordedChunks, { type: 'video/mp4' });
                          const videoUrl = URL.createObjectURL(videoBlob);
  
                          addVideoToGallery(videoUrl); // إضافة الفيديو إلى المعرض
                          showBootstrapToast('Vidéo enregistrée avec succès !', 'success');
  
                          // إيقاف البث وإغلاق النافذة المنبثقة
                          stream.getTracks().forEach(track => track.stop());
                          modal.remove();
                      };
  
  
                      mediaRecorder.start();
                      recordBtn.innerText = "Arrêter l'enregistrement vidéo";
                  } else if (mediaRecorder.state === "recording") {
                      mediaRecorder.stop();
                      recordBtn.innerText = "Commencer l'enregistrement vidéo";
                  }
              };
          })
          .catch(function (error) {
              console.error("Erreur lors de l'accès à la caméra:", error);
          });
  }
  

  // Function to show Bootstrap toasts
  function showBootstrapToast(message, type) {
      const toastHTML = `
          <div class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true">
              <div class="d-flex">
                  <div class="toast-body">
                      ${message}
                  </div>
                  <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
          </div>
      `;
      const toastContainer = document.getElementById('toastPlacement');
      toastContainer.insertAdjacentHTML('beforeend', toastHTML);

      // Initialize and show the toast
      const toastElement = toastContainer.querySelector('.toast:last-child');
      const toastInstance = new bootstrap.Toast(toastElement);
      toastInstance.show();

      // Remove the toast from the DOM after it hides
      toastElement.addEventListener('hidden.bs.toast', function () {
          toastElement.remove();
      });
  }
  
  // Ensure the "Add Video" button works and opens the camera modal
  document.body.addEventListener('click', function (event) {
      if (event.target && event.target.classList.contains('take-video-btn')) {
          event.preventDefault();
          openCamera();
      }
  });
</script>


</body>
</html>
